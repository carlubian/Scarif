@page "/app"
@using Microsoft.AspNetCore.SignalR.Client
@using Scarif.Server.Client.Core
@using Scarif.Protobuf
@implements IDisposable
@inject UpdateService Update
@inject NavigationManager NavManager

<h1>@AppName Logs</h1>

<p>These are the recorded logs for the @AppName App.</p>

<table class="table">
    <thead>
        <tr>
            <th>Component</th>
            <th>Severity</th>
            <th>Timestamp</th>
            <th>Message</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var log in Logs)
        {
            <tr>
                <td>@log.Component</td>
                <td><span class="@BadgeClassFromSeverity(log.Severity)">@log.Severity</span></td>
                <td>@log.Timestamp.ToDateTime().ToString("yyyy-MM-dd HH:mm:ss.fff")</td>
                <td>@log.Message</td>
            </tr>
        }
    </tbody>
</table>


@code {
    private HubConnection SignalR;
    public string AppName;
    public string AppUrl;

    public IEnumerable<LogMessage> Logs = new List<LogMessage>();

    protected override async Task OnInitializedAsync()
    {
        SignalR = new HubConnectionBuilder()
            .WithUrl(NavManager.ToAbsoluteUri("/scarif"))
            .Build();
        SignalR.On<string>("NotifyIncomingLog", HandleIncomingLog);
        await SignalR.StartAsync();

        await ParseQueryString();
        PopulateLogs();
        Update.Clear(AppName);
        Update.ActiveApp = AppName;
        NavManager.LocationChanged += HandleLocationChanged;
    }

    public async void PopulateLogs()
    {
        Logs = await SignalR.InvokeAsync<IEnumerable<LogMessage>>("RequestAppLogs", AppName);
        StateHasChanged();
    }

    async void HandleLocationChanged(object sender, LocationChangedEventArgs e)
    {
        await ParseQueryString();
        Logs = new List<LogMessage>();
        PopulateLogs();
        Update.Clear(AppName);
        Update.ActiveApp = AppName;
        StateHasChanged();
    }

    void HandleIncomingLog(string app)
    {
        if (app.Equals(AppName))
            PopulateLogs();
    }

    string BadgeClassFromSeverity(string severity)
    {
        switch (severity)
        {
            case "Trace":
                return "badge badge-secondary";
            case "Info":
                return "badge badge-info";
            case "Warning":
                return "badge badge-warning";
            case "Error":
                return "badge badge-danger";
            default:
                return "badge badge-light";
        }
    }

    /// <summary>
    /// Method used to figure out which app are we on.
    /// </summary>
    /// <returns></returns>
    private async Task ParseQueryString()
    {
        NavManager.TryGetQueryString<string>("id", out AppUrl);
        AppName = await SignalR.InvokeAsync<string>("AppNameFromUrl", AppUrl);
    }

    public void Dispose()
    {
        NavManager.LocationChanged -= HandleLocationChanged;
    }
}
