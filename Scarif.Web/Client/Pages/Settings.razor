@page "/settings"

@using Microsoft.AspNetCore.SignalR.Client
@inject NavigationManager NavigationManager

<h2 class="text-xl md:text-4xl tracking-wide">Settings</h2>

<p class="tracking-wide text-lg">
    Deleting an app will permanently remove it and all logs coming
    from it.
</p>
<p class="tracking-wide text-gray-400">Please allow a few seconds to populate the view when first navigating.</p>

<table class="table border-collapse w-full m-2 md:m-4">
    <thead>
        <tr class="border-b-2 border-yellow-600">
            <th>App name</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var app in Apps)
        {
            <tr class="hover:bg-gray-700">
                <td>@app.AppName (@app.AppId)</td>
                <td>
                    <button class="bg-red-500 p-2 md:p-4 tracking-wide rounded-xl" @onclick="_ => DeleteApp(app.AppId)">DELETE</button>
                </td>
            </tr>
        }
    </tbody>
</table>

@code {
    IEnumerable<Scarif.Core.Model.App> Apps = Enumerable.Empty<Scarif.Core.Model.App>();
    HubConnection SignalR;

    protected override async Task OnInitializedAsync()
    {
        SignalR = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri("/scarif"))
            .Build();

        await SignalR.StartAsync();

        Apps = await SignalR.InvokeAsync<IEnumerable<Scarif.Core.Model.App>>("GetApps");

        StateHasChanged();
    }

    async void DeleteApp(string AppId)
    {
        await SignalR.InvokeAsync("DeleteApp", AppId);
        Apps = await SignalR.InvokeAsync<IEnumerable<Scarif.Core.Model.App>>("GetApps");

        StateHasChanged();
    }
}
